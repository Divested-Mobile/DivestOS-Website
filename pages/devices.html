<?php
//Copyright (c) 2017-2018 Spot Communications, Inc.
//
//This program is free software: you can redistribute it and/or modify
//it under the terms of the GNU General Public License as published by
//the Free Software Foundation, either version 3 of the License, or
//(at your option) any later version.
//
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
//
//You should have received a copy of the GNU General Public License
//along with this program.  If not, see <https://www.gnu.org/licenses/>.

	error_reporting(E_ERROR | E_PARSE);
	session_start();
	$_SESSION['csrfToken'] = bin2hex(random_bytes(32));

	function getDeviceDownloads() {
		$base = noHTML($_GET["base"]);
		$base = str_replace("&period;", ".", $base);
		if(is_null($base) || strlen($base) == 0 || !(substr_count($base, '.') <= 1) || !(substr_count($base, '/') == 0)) {
			error();
			return;
		}
		$rootdir = "/builds/" . $base . "/";
		$realRootdir = $_SERVER['DOCUMENT_ROOT'] . $rootdir;
		if(!(is_dir($realRootdir))) {
			error();
			return;
		}
		$devices = scandir($realRootdir, 0);
		if(sizeof($devices) == 2) {
			print("It appears there are no builds for this base yet...");
			return;
		}
		$lastSecRelease = 1525824000; //The timestamp of when LineageOS merged the latest Android security bulletin patches, XXX: MUST BE MANUALLY UPDATED
		$curTime = time(); //Used to check if builds are older than 40 days as a fallback if the above isn't updated
		foreach ($devices as $device) {
			if(strlen($device) >= 2 && $device != '..') {
				print("<div class=\"card\">");
				$name = $device;
				$friendlyNamePath = $realRootdir . $device . "/friendlyName";
				if(file_exists($friendlyNamePath)) {
					$name = file_get_contents($friendlyNamePath) . " (" . $device . ")";
				}
				print("<h3>" . $name . "</h3>");
				print("<p><a href=\"https://wiki.lineageos.org/devices/" . $device . "\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Device Information</a> and <a href=\"https://wiki.lineageos.org/devices/" . $device . "/install\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Installation Guide</a></p>");
				$files = scandir($realRootdir . $device);
				if(sizeof($files) <= 4) {
					print("<h4>Currently Unavailable</h4>");
				} else {
					foreach ($files as $file) {
						if($file == "status" || $file == "recovery.img" || contains($file, "md5sum")) {
							continue;
						}
						if(strlen($file) > 30) {
							$downloadButtons = "<a href=\"/mirror.php?base=" . $base . "&f=" . $device . "/" . $file . "\" value=\"/mirror.php?base=" . $base . "&f=" . $device . "/" . $file . "\" class=\"button rom icon-upload\" onMouseOver=\"this.style.backgroundColor='#COLOUR'\" onMouseOut=\"this.style.backgroundColor='#e2e2e2'\">Download</a>";
							$latestFileTime = filemtime($realRootdir . $device . "/" .$file);
							break;
						}
					}
					if(file_exists($realRootdir . $device . "/recovery.img")) {
						$downloadButtons .= "<a href=\"/mirror.php?base=" . $base . "&f=" . $device . "/recovery.img\" class=\"button\" onMouseOver=\"this.style.backgroundColor='#COLOUR'\" onMouseOut=\"this.style.backgroundColor='#e2e2e2'\">Recovery</a>";
					}
					$outdated = !(($latestFileTime >= $lastSecRelease) && (($curTime - $latestFileTime) <= 3456000));
					$color = getStatus(file_get_contents($realRootdir . $device . "/status"), $outdated);
					$downloadButtons = str_replace("COLOUR", $color, $downloadButtons);
					print($downloadButtons);

				}
				print("</div>");
			}
		}
	}

	function getStatus($status, $outdated) {
		$message = "Unknown";
		$color = "03A9F4";
		if(!($status === false)) {
			switch($status) {
				case 0:
					$message = "Works";
					$color = "4CAF50";
					break;
				case 1:
					$message = "Broken";
					$color = "f44336";
					break;
				case 2:
					$message = "Untested";
					$color = "FFC107";
					break;
				case 3:
					$message = "Untested (Experimental)";
					$color = "673AB7";
					break;
			}
		}
		if($outdated) {
			$message = $message . " and Outdated";
			$color = "f44336";
		}
		print("<h5 style=\"color: #" . $color . ";\">" . $message . "</h5>");
		return $color;
	}

	function error() {
		print("Unknown base!");
		http_response_code(400);
	}

?>
				<div class="card fluid">
					<h2>Device Downloads</h2>
					<p>Releases are typically done on a fortnightly schedule unless there are major or security related changes.</p>
					<p>Currently in pre-release stage, please do *not* share, file mirror servers have not been set up yet.</p>
					<div class="section">
						<div class="row">
							<div class="card large">
								<h3>Disclaimer</h3>
								<p>Rarely will these builds be fully tested as we don't have every device we build for, due to that these are provided <b>without</b> warranty and <b>can</b> damage your device. We are <b>not</b> liable for <b>any</b> damage done by using these, and you yourself will be at fault.</p>
							</div>
							<div class="card large">
								<h3>Root</h3>
								<p>These are 'user' builds, root is not included. It is not recommended to flash any other zips alongside our builds. Root frameworks and runtime modification frameworks (like Xposed) will <b>severly decrease</b> the security of your device.</p>
							</div>
							<div class="card large">
								<h3>Signed Builds</h3>
								<p>All builds published are signed with our signing keys (CN: Spot Communications), unlike other ROMs that simply use test-keys. This means that when switching to or away from our builds, you will be prompted to wipe /data.</p>
							</div>

						</div>
					</div>
					<div class="section" style="text-align: center;">
						<h3>Name Your Price</h3>
						<input type="radio" id="radPriceFree" name="radPrice" checked>
						<label for="radPriceFree" id="lblPriceFree">Free</label>
						<input type="radio" id="radPriceTen" name="radPrice">
						<label for="radPriceTen">$10</label>
						<p id="lblThanks" hidden>Thank you for your contribution!</p>
					</div>
					<div class="section">
						<div class="row" style="text-align: center;">
							<?php getDeviceDownloads(); ?>
						</div>
					</div>
				</div>

				<script src="/assets/js/jquery.min.js"></script>
				<script src="/assets/js/purchase.js"></script>
