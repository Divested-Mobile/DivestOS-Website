<?php
//Copyright (c) 2017-2018 Divested Computing, Inc.
//
//This program is free software: you can redistribute it and/or modify
//it under the terms of the GNU General Public License as published by
//the Free Software Foundation, either version 3 of the License, or
//(at your option) any later version.
//
//This program is distributed in the hope that it will be useful,
//but WITHOUT ANY WARRANTY; without even the implied warranty of
//MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//GNU General Public License for more details.
//
//You should have received a copy of the GNU General Public License
//along with this program.  If not, see <https://www.gnu.org/licenses/>.

	error_reporting(E_ERROR | E_PARSE);
	session_start();
	$_SESSION['csrfToken'] = bin2hex(random_bytes(32));

	function getDownloads() {
		$base = noHTML($_GET["base"]);
		$base = str_replace("&period;", ".", $base);
		if(is_null($base) || strlen($base) == 0 || !(substr_count($base, '.') <= 1) || !(substr_count($base, '/') == 0)) {
			error();
			return;
		}

		$rootdir = "/builds/" . $base . "/";
		$realRootdir = $_SERVER['DOCUMENT_ROOT'] . $rootdir;
		if(!(is_dir($realRootdir))) {
			error();
			return;
		}

		$devices = scandir($realRootdir, 0);
		if(sizeof($devices) == 2) {
			print("It appears there are no builds for this base yet...");
			return;
		}

		print(getCachedDevices($base, $rootdir, $realRootdir, $devices));
	}

	function getCachedDevices($base, $rootdir, $realRootdir, $devices) {
		if(extension_loaded("redis")) {
			$result = "";
			$redis = new Redis();
			$redis->connect('127.0.0.1');
			$cacheKey = "DivestOS+devices.php+base:" . $base;
			if(($result = $redis->get($cacheKey)) == false) {
				$result = getDevices($base, $rootdir, $realRootdir, $devices);
				$redis->setEx($cacheKey, 3600, $result);
			}
			$redis->close();
			return $result;
		} else {
			return getDevices($base, $rootdir, $realRootdir, $devices);
		}
	}

	function getDevices($base, $rootdir, $realRootdir, $devices) {
		$downloads = "";
		$lastSecRelease = 1533427200; //The timestamp of when LineageOS merged the latest Android security bulletin patches, XXX: MUST BE MANUALLY UPDATED
		$curTime = time(); //Used to check if builds are older than 40 days as a fallback if the above isn't updated
		foreach ($devices as $device) {
			if(strlen($device) >= 2 && $device != '..') {
				$downloads .= "<div class=\"card centero\">";
				$name = $device;
				$friendlyNamePath = $realRootdir . $device . "/friendlyName";
				if(file_exists($friendlyNamePath)) {
					$name = file_get_contents($friendlyNamePath) . " (" . $device . ")";
				}
				$downloads .= "<h3>" . $name . "</h3>";
				$downloads .= "<p><a href=\"https://wiki.lineageos.org/devices/" . $device . "\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Device Info</a> and <a href=\"https://wiki.lineageos.org/devices/" . $device . "/install\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Install Guide</a></p>";
				$files = scandir($realRootdir . $device);
				if(sizeof($files) <= 4) {
					$downloads .= "<h4>Currently Unavailable</h4>";
				} else {
					foreach ($files as $file) {
						if($file == "status" || $file == "recovery.img" || contains($file, "md5sum")) {
							continue;
						}
						if(strlen($file) > 30) {
							$downloadButtons = "<a href=\"/mirror.php?base=" . $base . "&f=" . $device . "/" . $file . "\" value=\"/mirror.php?base=" . $base . "&f=" . $device . "/" . $file . "\" class=\"button primary rom-unknown\" onMouseOver=\"this.style.backgroundColor='#COLOUR'\" onMouseOut=\"this.style.backgroundColor='var(--button-back-color)'\">Download</a>";
							$latestFileTime = filemtime($realRootdir . $device . "/" .$file);
							break;
						}
					}
					if(file_exists($realRootdir . $device . "/recovery.img")) {
						$downloadButtons .= "<br><a href=\"/mirror.php?base=" . $base . "&f=" . $device . "/recovery.img\" class=\"button inverse small\">Recovery</a>";
					}
					$outdated = !(($latestFileTime >= $lastSecRelease) && (($curTime - $latestFileTime) <= 3456000));
					list($color, $statusMessage) = getStatus(file_get_contents($realRootdir . $device . "/status"), $outdated);
					$downloads .= "<h5 style=\"color: #" . $color . ";\">" . $statusMessage . "</h5>";
					if($color === "4CAF50") {
						$downloadButtons = str_replace("rom-unknown", "rom-working", $downloadButtons);
					}
					$downloadButtons = str_replace("COLOUR", $color, $downloadButtons);
					$downloads .= $downloadButtons;

				}
				$downloads .= "</div>";
			}
		}
		return $downloads;
	}

	function getStatus($status, $outdated) {
		$color = "03A9F4";
		$message = "Unknown";
		if(!($status === false)) {
			switch($status) {
				case 0:
					$color = "4CAF50";
					$message = "Works";
					break;
				case 1:
					$color = "f44336";
					$message = "Broken";
					break;
				case 2:
					$color = "FFC107";
					$message = "Untested";
					break;
				case 3:
					$color = "673AB7";
					$message = "Untested (Experimental)";
					break;
			}
		}
		if($outdated) {
			$color = "f44336";
			$message = $message . " and Outdated";
		}
		return array($color, $message);
	}

	function error() {
		print("Unknown base!");
		http_response_code(400);
	}

?>
				<div class="card fluid">
					<h2>Device Downloads</h2>
					<p>Releases are typically done on a fortnightly schedule unless there are major or security related changes.</p>
					<noscript><p>Currently in pre-release, please do not share! Mirror servers have not been setup!</p></noscript>
					<div class="section">
						<div class="row">
							<div class="card centero large">
								<h3>Disclaimer</h3>
								<p>Rarely will these builds be fully tested as we don't have every device we build for, due to that these are provided <b>without</b> warranty and <b>can</b> damage your device. We are <b>not</b> liable for <b>any</b> damage done by using these, and you yourself will be at fault.</p>
							</div>
							<div class="card centero large">
								<h3>Root</h3>
								<p>These are 'user' builds, root is not included. It is not recommended to flash any other zips alongside our builds. Root frameworks and runtime modification frameworks will <b>severely decrease</b> the security of your device.</p>
							</div>
							<div class="card centero large">
								<h3>Signed Builds</h3>
								<p>All builds published are signed with our signing keys, unlike other ROMs that simply use test-keys. This means that when switching to or away from our builds, you will be prompted to wipe /data.</p>
							</div>
						</div>
					</div>
					<div class="section hidden" id="nameYourPrice" style="text-align: center;">
						<h3>Name Your Price</h3>
						<input type="radio" id="radPriceFree" name="radPrice" checked>
						<label for="radPriceFree" id="lblPriceFree">Free</label>
						<input type="radio" id="radPriceTen" name="radPrice">
						<label for="radPriceTen">$10</label>
						<p id="lblThanks" hidden>Thank you for your contribution!</p>
					</div>
					<div class="section">
						<div class="row" style="text-align: center;">
							<?php getDownloads(); ?>
						</div>
					</div>
				</div>

				<script type="text/javascript">
					function getCSRFToken() {
						return "<?php print($_SESSION['csrfToken']); ?>";
					}
				</script>
				<script type="text/javascript" src="/assets/js/purchase.js" integrity="sha384-upELWODDbmHONrJWGWa5QObnn6hSXaOz+8nSTGMBGvHkQDGjmZbEm4v31WRjA9T3"></script>
